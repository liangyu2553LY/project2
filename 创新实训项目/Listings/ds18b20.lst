C51 COMPILER V9.56.0.0   DS18B20                                                           04/11/2022 19:07:32 PAGE 1   


C51 COMPILER V9.56.0.0, COMPILATION OF MODULE DS18B20
OBJECT MODULE PLACED IN .\Objects\ds18b20.obj
COMPILER INVOKED BY: D:\keil\C51\BIN\C51.EXE ds18b20.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\ds18
                    -b20.lst) TABS(2) OBJECT(.\Objects\ds18b20.obj)

line level    source

   1          #include "ds18b20.h"
   2          #include "intrins.h"
   3          #include <delay.h>
   4          #define u8 unsigned char
   5          #define u16 unsigned int
   6          /*******************************************************************************
   7          * 函 数 名         : ds18b20_reset
   8          * 函数功能       : 复位DS18B20  
   9          * 输    入         : 无
  10          * 输    出         : 无
  11          *******************************************************************************/
  12          void ds18b20_reset(void)
  13          {
  14   1        DS18B20_PORT=0; //拉低DQ
  15   1        delay_10us(75); //拉低750us
  16   1        DS18B20_PORT=1; //DQ=1
  17   1        delay_10us(2);  //20US
  18   1      }
  19          
  20          /*******************************************************************************
  21          * 函 数 名         : ds18b20_check
  22          * 函数功能       : 检测DS18B20是否存在
  23          * 输    入         : 无
  24          * 输    出         : 1:未检测到DS18B20的存在，0:存在
  25          *******************************************************************************/
  26          unsigned char ds18b20_check(void)
  27          {
  28   1        u8 time_temp=0;
  29   1      
  30   1        while(DS18B20_PORT&&time_temp<20) //等待DQ为低电平
  31   1        {
  32   2          time_temp++;
  33   2          delay_10us(1);  
  34   2        }
  35   1        if(time_temp>=20)return 1;  //如果超时则强制返回1
  36   1        else time_temp=0;
  37   1        while((!DS18B20_PORT)&&time_temp<20)  //等待DQ为高电平
  38   1        {
  39   2          time_temp++;
  40   2          delay_10us(1);
  41   2        }
  42   1        if(time_temp>=20)return 1;  //如果超时则强制返回1
  43   1        return 0;
  44   1      }
  45          
  46          /*******************************************************************************
  47          * 函 数 名         : ds18b20_read_bit
  48          * 函数功能       : 从DS18B20读取一个位
  49          * 输    入         : 无
  50          * 输    出         : 1/0
  51          *******************************************************************************/
  52          u8 ds18b20_read_bit(void)
  53          {
  54   1        u8 dat=0;
C51 COMPILER V9.56.0.0   DS18B20                                                           04/11/2022 19:07:32 PAGE 2   

  55   1        
  56   1        DS18B20_PORT=0;
  57   1        _nop_();_nop_();
  58   1        DS18B20_PORT=1; 
  59   1        _nop_();_nop_(); //该段时间不能过长，必须在15us内读取数据
  60   1        if(DS18B20_PORT)dat=1;  //如果总线上为1则数据dat为1，否则为0
  61   1        else dat=0;
  62   1        delay_10us(5);
  63   1        return dat;
  64   1      } 
  65          
  66          /*******************************************************************************
  67          * 函 数 名         : ds18b20_read_byte
  68          * 函数功能       : 从DS18B20读取一个字节
  69          * 输    入         : 无
  70          * 输    出         : 一个字节数据
  71          *******************************************************************************/
  72          u8 ds18b20_read_byte(void)
  73          {
  74   1        u8 i=0;
  75   1        u8 dat=0;
  76   1        u8 temp=0;
  77   1      
  78   1        for(i=0;i<8;i++)//循环8次，每次读取一位，且先读低位再读高位
  79   1        {
  80   2          temp=ds18b20_read_bit();
  81   2          dat=(temp<<7)|(dat>>1);
  82   2        }
  83   1        return dat; 
  84   1      }
  85          
  86          /*******************************************************************************
  87          * 函 数 名         : ds18b20_write_byte
  88          * 函数功能       : 写一个字节到DS18B20
  89          * 输    入         : dat：要写入的字节
  90          * 输    出         : 无
  91          *******************************************************************************/
  92          void ds18b20_write_byte(u8 dat)
  93          {
  94   1        u8 i=0;
  95   1        u8 temp=0;
  96   1      
  97   1        for(i=0;i<8;i++)//循环8次，每次写一位，且先写低位再写高位
  98   1        {
  99   2          temp=dat&0x01;//选择低位准备写入
 100   2          dat>>=1;//将次高位移到低位
 101   2          if(temp)
 102   2          {
 103   3            DS18B20_PORT=0;
 104   3            _nop_();_nop_();
 105   3            DS18B20_PORT=1; 
 106   3            delay_10us(6);
 107   3          }
 108   2          else
 109   2          {
 110   3            DS18B20_PORT=0;
 111   3            delay_10us(6);
 112   3            DS18B20_PORT=1;
 113   3            _nop_();_nop_();  
 114   3          } 
 115   2        } 
 116   1      }
C51 COMPILER V9.56.0.0   DS18B20                                                           04/11/2022 19:07:32 PAGE 3   

 117          
 118          /*******************************************************************************
 119          * 函 数 名         : ds18b20_start
 120          * 函数功能       : 开始温度转换
 121          * 输    入         : 无
 122          * 输    出         : 无
 123          *******************************************************************************/
 124          void ds18b20_start(void)
 125          {
 126   1        ds18b20_reset();//复位
 127   1        ds18b20_check();//检查DS18B20
 128   1        ds18b20_write_byte(0xcc);//SKIP ROM
 129   1          ds18b20_write_byte(0x44);//转换命令 
 130   1      }
 131          
 132          /*******************************************************************************
 133          * 函 数 名         : ds18b20_init
 134          * 函数功能       : 初始化DS18B20的IO口 DQ 同时检测DS的存在
 135          * 输    入         : 无
 136          * 输    出         : 1:不存在，0:存在
 137          *******************************************************************************/ 
 138          u8 ds18b20_init(void)
 139          {
 140   1        ds18b20_reset();
 141   1        return ds18b20_check(); 
 142   1      }
 143          
 144          /*******************************************************************************
 145          * 函 数 名         : ds18b20_read_temperture
 146          * 函数功能       : 从ds18b20得到温度值
 147          * 输    入         : 无
 148          * 输    出         : 温度数据
 149          *******************************************************************************/
 150          float ds18b20_read_temperture(void)
 151          {
 152   1        float temp;
 153   1        u8 dath=0;
 154   1        u8 datl=0;
 155   1        u16 value=0;
 156   1      
 157   1        ds18b20_start();//开始转换
 158   1        ds18b20_reset();//复位
 159   1        ds18b20_check();
 160   1        ds18b20_write_byte(0xcc);//SKIP ROM
 161   1          ds18b20_write_byte(0xbe);//读存储器
 162   1      
 163   1        datl=ds18b20_read_byte();//低字节
 164   1        dath=ds18b20_read_byte();//高字节
 165   1        value=(dath<<8)+datl;//合并为16位数据
 166   1      
 167   1        if((value&0xf800)==0xf800)//判断符号位，负温度
 168   1        {
 169   2          value=(~value)+1; //数据取反再加1
 170   2          temp=value*(-0.0625);//乘以精度 
 171   2        }
 172   1        else //正温度
 173   1        {
 174   2          temp=value*0.0625;  
 175   2        }
 176   1        return temp;
 177   1      }

C51 COMPILER V9.56.0.0   DS18B20                                                           04/11/2022 19:07:32 PAGE 4   


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    368    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      14
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
