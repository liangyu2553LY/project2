#include <reg52.h>
#include <intrins.h>
#include <LCD12864.h>

//数字字模
uint8 code ch[]=
{
0x00,0xE0,0x10,0x08,0x08,0x10,0xE0,0x00,0x00,0x0F,0x10,0x20,0x20,0x10,0x0F,0x00,/*"0",0*/

0x00,0x00,0x10,0x10,0xF8,0x00,0x00,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,/*"1",1*/

0x00,0x70,0x08,0x08,0x08,0x08,0xF0,0x00,0x00,0x30,0x28,0x24,0x22,0x21,0x30,0x00,/*"2",2*/

0x00,0x30,0x08,0x08,0x08,0x88,0x70,0x00,0x00,0x18,0x20,0x21,0x21,0x22,0x1C,0x00,/*"3",3*/

0x00,0x00,0x80,0x40,0x30,0xF8,0x00,0x00,0x00,0x06,0x05,0x24,0x24,0x3F,0x24,0x24,/*"4",4*/

0x00,0xF8,0x88,0x88,0x88,0x08,0x08,0x00,0x00,0x19,0x20,0x20,0x20,0x11,0x0E,0x00,/*"5",5*/

0x00,0xE0,0x10,0x88,0x88,0x90,0x00,0x00,0x00,0x0F,0x11,0x20,0x20,0x20,0x1F,0x00,/*"6",6*/

0x00,0x18,0x08,0x08,0x88,0x68,0x18,0x00,0x00,0x00,0x00,0x3E,0x01,0x00,0x00,0x00,/*"7",7*/

0x00,0x70,0x88,0x08,0x08,0x88,0x70,0x00,0x00,0x1C,0x22,0x21,0x21,0x22,0x1C,0x00,/*"8",8*/

0x00,0xF0,0x08,0x08,0x08,0x10,0xE0,0x00,0x00,0x01,0x12,0x22,0x22,0x11,0x0F,0x00/*"9",9*/

};
//冒号
uint8 code ch1[]=
{
0x00,0x00,0x00,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00,0x00,0x00,/*":",0*/
};
//空
uint8 code clear[]=
{
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,/*":",0*/
};

//图像
uint8 code image1[]=
{0x00,0x00,0x80,0xC0,0xE0,0xE0,0xE0,0xE0,0xE6,0xEE,0xFE,0xFC,0xF8,0xE0,0xE0,0xE0,
0xE0,0xE0,0xF8,0xFC,0xFE,0xEE,0xE6,0xE0,0xE0,0xE0,0xE0,0xC0,0x80,0x00,0x00,0x00,
0x00,0xFF,0xFF,0xFF,0xFF,0x01,0xC1,0xC1,0xE1,0xE1,0xE1,0xE1,0xE1,0x01,0x01,0x01,
0x01,0x01,0xE1,0xE1,0xE1,0xE1,0xE1,0xC1,0xC1,0x01,0xFF,0xFF,0xFF,0xFE,0x00,0x00,
0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x01,0x01,0x01,0x01,0x00,0x10,0x70,0x60,0x70,0x38,
0x60,0x60,0x30,0x00,0x00,0x01,0x01,0x01,0x01,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,
0x00,0x03,0x0F,0x1F,0x1F,0x3E,0x3E,0x7C,0x7C,0x7C,0x3C,0x3C,0x3C,0x3C,0x3C,0x3C,
0x3C,0x3C,0x3C,0x3C,0x3C,0x7C,0x7C,0x7C,0x3C,0x3E,0x1F,0x1F,0x0F,0x03,0x00,0x00};

uint16 THHL=65536-50000;//每隔50ms溢出
uint8 hour=0,min=0,sec=0;
uint8 show = 1;
uint8 d = 20;
sbit key = P1^0;
sbit chose = P1^1;
sbit up = P1^2;

void keyscan()   
{       
	uint8 i=0;
	uint16 delay=30000;
	if(!key) //使用P1.0作为调整按钮   
	{   
		while(!key);	//等待按键松开 
		TR0=0;					//关闭计时中断
		while(key)			//再次按下P1.0，退出调节
		{
			if(!chose)
			{
				while(!chose);
				i++;if(i>2){i=0;}
			}
			switch(i)
			{
				case 0:	if(!up)
								{
									while(!up);
									sec+=1;
									if(sec>59)sec=0;
								}
								show_ch(2,4,4*8,clear);
								show_ch(2,4,5*8,clear);
								while(delay--);delay=30000;
								show_ch(2,4,4*8,ch+16*(sec/10));
								show_ch(2,4,5*8,ch+16*(sec%10));
								while(delay--);delay=30000;break;
				case 1: if(!up)
								{
									while(!up);
									min+=1;
									if(min>59)min=0;
								}
								show_ch(2,4,1*8,clear);
								show_ch(2,4,2*8,clear);
								while(delay--);delay=30000;
								show_ch(2,4,1*8,ch+16*(min/10));
								show_ch(2,4,2*8,ch+16*(min%10));
								while(delay--);delay=30000;break;				
				case 2: if(!up)
								{
									while(!up);
									hour+=1;
									if(hour>23)hour=0;
								}
								show_ch(1,4,6*8,clear);
								show_ch(1,4,7*8,clear);
								while(delay--);delay=30000;
								show_ch(1,4,6*8,ch+16*(hour/10));
								show_ch(1,4,7*8,ch+16*(hour%10));
								while(delay--);delay=30000;break;	
			}
			
		}
		while(!key);	//等待按键松开 
		TR0=1;					//恢复定时器中断
	}   
}



void main()
{
	InitLCD();
	ClearScreen(0);
	Set_line(0);
	show_im(1,2,0*16,image1);
	show_ch(2,4,0*8,ch1);
	show_ch(2,4,3*8,ch1);
	
	TMOD &=0X0F;
  TMOD |=0x01;
  TH0 = THHL /256;//高四位初值
  TL0 = THHL %256;//低四位初值
  EA = 1; 	   //开总中断
  ET0 = 1;	   //T1开时定时器溢出
  TR0 = 1;	   //开启定时器

	while(1)
	{
		if(show){
			show_ch(1,4,6*8,ch+16*(hour/10));
			show_ch(1,4,7*8,ch+16*(hour%10));
			show_ch(2,4,1*8,ch+16*(min/10));
			show_ch(2,4,2*8,ch+16*(min%10));
			show_ch(2,4,4*8,ch+16*(sec/10));
			show_ch(2,4,5*8,ch+16*(sec%10));
			show = 0; //只更新一次数据，防止中断打断传输导致错误。
		}
		keyscan();
	}
}

void time_intt1(void) interrupt 1  
{ 
	TH0=THHL/256;TL0=THHL%256; 
	d--; 
	if(d==0)
	{
		sec+=1;    
		show=1;
		if(sec>59){sec=0;min+=1;}
		if(min>59){min=0;hour+=1;}
		if(hour>23){hour=0;}
		d=20;
	}
}   